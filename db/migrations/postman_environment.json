{
  "info": {
    "_postman_id": "a2b2b1f8-8c9b-4f1c-a3f4-3f6e2d987001",
    "name": "KUB API (RBAC)",
    "description": "Postman collection for KUB API with role-based access control. Login to obtain access token; all protected requests use {{accessToken}}.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Login (save accessToken)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/login", "host": ["{{baseUrl}}"], "path": ["login"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@example.com\",\n  \"password\": \"admin123\"\n}"
            },
            "description": "Authenticates user and stores tokens.access_token to {{accessToken}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
                  "try {",
                  "  const data = pm.response.json();",
                  "  const token = data.tokens && data.tokens.access_token;",
                  "  pm.test('access_token present', function(){ pm.expect(token).to.be.a('string'); });",
                  "  pm.collectionVariables.set('accessToken', token || '');",
                  "} catch(e) {",
                  "  pm.test('parse error', function(){ throw e; });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Refresh Access Token",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/refresh", "host": ["{{baseUrl}}"], "path": ["refresh"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refresh_token\": \"PUT_REFRESH_TOKEN_HERE\"\n}"
            }
          }
        },
        {
          "name": "Public Register (Sales by default)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/register", "host": ["{{baseUrl}}"], "path": ["register"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Acme LLC\",\n  \"bin_iin\": \"123456789012\",\n  \"email\": \"sales1@example.com\",\n  \"password\": \"sales12345\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Users (Admin/Mgmt/Audit read, Admin manage)",
      "item": [
        {
          "name": "Create User (Admin only)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Ops Dept\",\n  \"bin_iin\": \"990011223344\",\n  \"email\": \"ops@example.com\",\n  \"password\": \"ops12345\",\n  \"role_id\": 20\n}"
            }
          }
        },
        {
          "name": "List Users (Mgmt/Admin/Audit)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/users?page=1&limit=20",
              "host": ["{{baseUrl}}"],
              "path": ["users"],
              "query": [{ "key": "page", "value": "1" }, { "key": "limit", "value": "20" }]
            }
          }
        },
        {
          "name": "Get User By ID",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/users/1", "host": ["{{baseUrl}}"], "path": ["users", "1"] }
          }
        },
        {
          "name": "Update User (Admin any / Non-admin self only)",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users/1", "host": ["{{baseUrl}}"], "path": ["users", "1"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Acme HQ\",\n  \"bin_iin\": \"123456789012\",\n  \"email\": \"admin@example.com\",\n  \"password_hash\": \"$2b$10$keepExistingHash\",\n  \"role_id\": 50\n}"
            }
          }
        },
        {
          "name": "Delete User (Admin only)",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/users/5", "host": ["{{baseUrl}}"], "path": ["users", "5"] }
          }
        },
        {
          "name": "Users Count (Mgmt/Admin/Audit)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/users/count", "host": ["{{baseUrl}}"], "path": ["users", "count"] }
          }
        },
        {
          "name": "Users Count By Role (Mgmt/Admin/Audit)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/users/count/role/20", "host": ["{{baseUrl}}"], "path": ["users", "count", "role", "20"] }
          }
        }
      ]
    },
    {
      "name": "Leads (RBAC)",
      "item": [
        {
          "name": "Create Lead (owner = current user)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads", "host": ["{{baseUrl}}"], "path": ["leads"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"New client A\",\n  \"description\": \"Lead from expo\",\n  \"status\": \"new\"\n}"
            }
          }
        },
        {
          "name": "List Leads (Sales: mine; Ops/Mgmt/Admin/Audit: all)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/leads?page=1&size=20",
              "host": ["{{baseUrl}}"],
              "path": ["leads"],
              "query": [{ "key": "page", "value": "1" }, { "key": "size", "value": "20" }]
            }
          }
        },
        {
          "name": "Get Lead By ID",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1", "host": ["{{baseUrl}}"], "path": ["leads", "1"] }
          }
        },
        {
          "name": "Update Lead",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1", "host": ["{{baseUrl}}"], "path": ["leads", "1"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"New client A (updated)\",\n  \"description\": \"Updated notes\",\n  \"owner_id\": 0,\n  \"status\": \"confirmed\"\n}"
            },
            "description": "owner_id будет игнорирован для не-elevated ролей"
          }
        },
        {
          "name": "Delete Lead",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1", "host": ["{{baseUrl}}"], "path": ["leads", "1"] }
          }
        },
        {
          "name": "Convert Lead → Deal",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1/convert", "host": ["{{baseUrl}}"], "path": ["leads", "1", "convert"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"amount\": \"50000\",\n  \"currency\": \"USD\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Deals (RBAC)",
      "item": [
        {
          "name": "Create Deal (owner = current user)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/deals", "host": ["{{baseUrl}}"], "path": ["deals"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"lead_id\": 1,\n  \"amount\": \"50000\",\n  \"currency\": \"USD\",\n  \"status\": \"new\"\n}"
            }
          }
        },
        {
          "name": "List Deals (Sales: mine; Ops/Mgmt/Admin/Audit: all)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/deals?page=1&size=20",
              "host": ["{{baseUrl}}"],
              "path": ["deals"],
              "query": [{ "key": "page", "value": "1" }, { "key": "size", "value": "20" }]
            }
          }
        },
        {
          "name": "Get Deal By ID",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] }
          }
        },
        {
          "name": "Update Deal",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"lead_id\": 1,\n  \"owner_id\": 0,\n  \"amount\": \"52000\",\n  \"currency\": \"USD\",\n  \"status\": \"negotiation\"\n}"
            },
            "description": "owner_id игнорируется для не-elevated ролей"
          }
        },
        {
          "name": "Delete Deal",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] }
          }
        }
      ]
    },
    {
      "name": "Documents",
      "item": [
        {
          "name": "Create Document from Lead (by Deal of Lead owner)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/documents/create-from-lead", "host": ["{{baseUrl}}"], "path": ["documents", "create-from-lead"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"lead_id\": 1,\n  \"doc_type\": \"contract\"\n}"
            }
          }
        },
        {
          "name": "List Documents (role-dependent scope)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/documents", "host": ["{{baseUrl}}"], "path": ["documents"] }
          }
        },
        {
          "name": "Get Document by ID",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/documents/1", "host": ["{{baseUrl}}"], "path": ["documents", "1"] }
          }
        },
        {
          "name": "Delete Document (Ops/Mgmt/Admin)",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/documents/1", "host": ["{{baseUrl}}"], "path": ["documents", "1"] }
          }
        }
      ]
    },
    {
      "name": "Tasks",
      "item": [
        {
          "name": "Create Task",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/tasks", "host": ["{{baseUrl}}"], "path": ["tasks"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"creator_id\": 1,\n  \"assignee_id\": 2,\n  \"entity_id\": 1,\n  \"entity_type\": \"deal\",\n  \"title\": \"Prepare contract\",\n  \"description\": \"Draft v1\",\n  \"status\": \"open\"\n}"
            }
          }
        },
        {
          "name": "List Tasks",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/tasks", "host": ["{{baseUrl}}"], "path": ["tasks"] }
          }
        }
      ]
    },
    {
      "name": "Messages",
      "item": [
        {
          "name": "Send Message",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/messages", "host": ["{{baseUrl}}"], "path": ["messages"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"receiver_id\": 2,\n  \"content\": \"Hello!\"\n}"
            }
          }
        },
        {
          "name": "Get Conversations",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ],
            "url": { "raw": "{{baseUrl}}/messages/conversations", "host": ["{{baseUrl}}"], "path": ["messages", "conversations"] }
          }
        }
      ]
    },
    {
      "name": "SMS",
      "item": [
        {
          "name": "Send SMS for Document",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/sms/send", "host": ["{{baseUrl}}"], "path": ["sms", "send"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"document_id\": 1,\n  \"phone\": \"+77000000000\"\n}"
            }
          }
        },
        {
          "name": "Confirm SMS",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/sms/confirm", "host": ["{{baseUrl}}"], "path": ["sms", "confirm"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"document_id\": 1,\n  \"sms_code\": \"1234\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Reports (read-only)",
      "item": [
        {
          "name": "Summary",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/reports/summary", "host": ["{{baseUrl}}"], "path": ["reports", "summary"] }
          }
        },
        {
          "name": "Filter Leads",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/reports/leads/filter?status=confirmed&owner_id=1&sortBy=created_at&order=desc&limit=20&offset=0",
              "host": ["{{baseUrl}}"],
              "path": ["reports", "leads", "filter"],
              "query": [
                { "key": "status", "value": "confirmed" },
                { "key": "owner_id", "value": "1" },
                { "key": "sortBy", "value": "created_at" },
                { "key": "order", "value": "desc" },
                { "key": "limit", "value": "20" },
                { "key": "offset", "value": "0" }
              ]
            }
          }
        },
        {
          "name": "Filter Deals",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/reports/deals/filter?status=new&currency=USD&amountMin=0&amountMax=0&sortBy=created_at&order=desc&limit=20&offset=0",
              "host": ["{{baseUrl}}"],
              "path": ["reports", "deals", "filter"],
              "query": [
                { "key": "status", "value": "new" },
                { "key": "currency", "value": "USD" },
                { "key": "amountMin", "value": "0" },
                { "key": "amountMax", "value": "0" },
                { "key": "sortBy", "value": "created_at" },
                { "key": "order", "value": "desc" },
                { "key": "limit", "value": "20" },
                { "key": "offset", "value": "0" }
              ]
            }
          }
        }
      ]
    }
  ],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:4000" },
    { "key": "accessToken", "value": "" }
  ]
}
