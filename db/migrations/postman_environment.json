{
  "info": {
    "_postman_id": "3f2b7e9d-7b63-4d7c-9b2d-0f2a7a5b9001",
    "name": "KUB API (RBAC, updated v2)",
    "description": "Коллекция для KUB API с ролевой моделью: sales(10), operations(20), audit(30), management(40), admin(50), staff(15). Сначала /login, затем использовать {{accessToken}}. Для документов храните относительные пути (например, \"contract_v1.pdf\").",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Login (save tokens)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/login", "host": ["{{baseUrl}}"], "path": ["login"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@example.com\",\n  \"password\": \"admin123\"\n}"
            },
            "description": "Аутентификация. Сохраняет {{accessToken}} и {{refreshToken}}."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
                  "const data = pm.response.json();",
                  "const at = data?.tokens?.access_token;",
                  "const rt = data?.tokens?.refresh_token;",
                  "pm.test('access_token present', function(){ pm.expect(at).to.be.a('string').and.not.empty; });",
                  "pm.collectionVariables.set('accessToken', at || '');",
                  "if (rt) { pm.collectionVariables.set('refreshToken', rt); }"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Refresh Access Token",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/refresh", "host": ["{{baseUrl}}"], "path": ["refresh"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"refresh_token\": \"{{refreshToken}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status 200', function () { pm.response.to.have.status(200); });",
                  "const data = pm.response.json();",
                  "const at = data?.access_token;",
                  "pm.test('new access_token present', function(){ pm.expect(at).to.be.a('string').and.not.empty; });",
                  "pm.collectionVariables.set('accessToken', at || '');"
                ],
                "type": "text/javascript"
              }
            }
          ]
        },
        {
          "name": "Public Register (defaults to sales=10)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/register", "host": ["{{baseUrl}}"], "path": ["register"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Acme LLC\",\n  \"bin_iin\": \"123456789012\",\n  \"email\": \"sales1@example.com\",\n  \"password\": \"sales12345\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Users (Admin manage; Mgmt/Admin/Audit read)",
      "item": [
        {
          "name": "Create User - SALES (10)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Sales Dept\",\n  \"bin_iin\": \"990011223300\",\n  \"email\": \"sales2@example.com\",\n  \"password\": \"sales2345\",\n  \"role_id\": 10\n}"
            }
          }
        },
        {
          "name": "Create User - OPERATIONS (20)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Ops Dept\",\n  \"bin_iin\": \"990011223344\",\n  \"email\": \"ops@example.com\",\n  \"password\": \"ops12345\",\n  \"role_id\": 20\n}"
            }
          }
        },
        {
          "name": "Create User - AUDIT (30)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Audit\",\n  \"bin_iin\": \"990011223355\",\n  \"email\": \"audit@example.com\",\n  \"password\": \"audit12345\",\n  \"role_id\": 30\n}"
            }
          }
        },
        {
          "name": "Create User - MANAGEMENT (40)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Management\",\n  \"bin_iin\": \"990011223366\",\n  \"email\": \"mgmt@example.com\",\n  \"password\": \"mgmt12345\",\n  \"role_id\": 40\n}"
            }
          }
        },
        {
          "name": "Create User - ADMIN (50)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Admin\",\n  \"bin_iin\": \"990011223377\",\n  \"email\": \"admin2@example.com\",\n  \"password\": \"admin2345\",\n  \"role_id\": 50\n}"
            }
          }
        },
        {
          "name": "Create User - STAFF (15, messenger & tasks only)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/users", "host": ["{{baseUrl}}"], "path": ["users"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"company_name\": \"Staff\",\n  \"bin_iin\": \"990011223388\",\n  \"email\": \"staff@example.com\",\n  \"password\": \"staff12345\",\n  \"role_id\": 15\n}"
            }
          }
        },
        {
          "name": "List Users (Mgmt/Admin/Audit)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/users?page=1&limit=50",
              "host": ["{{baseUrl}}"],
              "path": ["users"],
              "query": [{ "key": "page", "value": "1" }, { "key": "limit", "value": "50" }]
            }
          }
        },
        {
          "name": "Get User By ID",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/users/1", "host": ["{{baseUrl}}"], "path": ["users", "1"] }
          }
        },
        {
          "name": "Delete User (Admin only)",
          "request": {
            "method": "DELETE",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/users/5", "host": ["{{baseUrl}}"], "path": ["users", "5"] }
          }
        }
      ]
    },
    {
      "name": "Leads",
      "item": [
        {
          "name": "Create Lead (owner = current user)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads", "host": ["{{baseUrl}}"], "path": ["leads"] },
            "body": { "mode": "raw", "raw": "{\n  \"title\": \"Client A\",\n  \"description\": \"From expo\",\n  \"status\": \"new\"\n}" }
          }
        },
        {
          "name": "List Leads (Sales: mine; Ops/Mgmt/Admin/Audit: all)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/leads?page=1&size=20",
              "host": ["{{baseUrl}}"],
              "path": ["leads"],
              "query": [{ "key": "page", "value": "1" }, { "key": "size", "value": "20" }]
            }
          }
        },
        {
          "name": "Get Lead By ID",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/leads/1", "host": ["{{baseUrl}}"], "path": ["leads", "1"] }
          }
        },
        {
          "name": "Update Lead (elevated:any / sales:own)",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1", "host": ["{{baseUrl}}"], "path": ["leads", "1"] },
            "body": { "mode": "raw", "raw": "{\n  \"title\": \"Client A (updated)\",\n  \"description\": \"Notes\",\n  \"status\": \"confirmed\"\n}" }
          }
        },
        {
          "name": "Convert Lead → Deal",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/leads/1/convert", "host": ["{{baseUrl}}"], "path": ["leads", "1", "convert"] },
            "body": { "mode": "raw", "raw": "{\n  \"amount\": \"50000\",\n  \"currency\": \"USD\"\n}" }
          }
        }
      ]
    },
    {
      "name": "Deals",
      "item": [
        {
          "name": "Create Deal (owner = current user)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/deals", "host": ["{{baseUrl}}"], "path": ["deals"] },
            "body": { "mode": "raw", "raw": "{\n  \"lead_id\": 1,\n  \"amount\": \"50000\",\n  \"currency\": \"USD\",\n  \"status\": \"new\"\n}" }
          }
        },
        {
          "name": "List Deals (Sales: mine; Ops/Mgmt/Admin/Audit: all)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/deals?page=1&size=20",
              "host": ["{{baseUrl}}"],
              "path": ["deals"],
              "query": [{ "key": "page", "value": "1" }, { "key": "size", "value": "20" }]
            }
          }
        },
        {
          "name": "Get Deal By ID",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] }
          }
        },
        {
          "name": "Update Deal (elevated:any / sales:own)",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] },
            "body": { "mode": "raw", "raw": "{\n  \"lead_id\": 1,\n  \"amount\": \"52000\",\n  \"currency\": \"USD\",\n  \"status\": \"negotiation\"\n}" }
          }
        },
        {
          "name": "Delete Deal",
          "request": {
            "method": "DELETE",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/deals/1", "host": ["{{baseUrl}}"], "path": ["deals", "1"] }
          }
        }
      ]
    },
    {
      "name": "Documents",
      "item": [
        {
          "name": "Create Document (by deal) — use relative file_path",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/documents", "host": ["{{baseUrl}}"], "path": ["documents"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"deal_id\": 1,\n  \"doc_type\": \"contract\",\n  \"file_path\": \"contract_v1.pdf\",\n  \"status\": \"draft\"\n}"
            }
          }
        },
        {
          "name": "Create Document FROM LEAD (auto by lead's deal)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/documents/create-from-lead", "host": ["{{baseUrl}}"], "path": ["documents", "create-from-lead"] },
            "body": { "mode": "raw", "raw": "{\n  \"lead_id\": 1,\n  \"doc_type\": \"contract\"\n}" }
          }
        },
        {
          "name": "List Documents (global; Sales запрещено)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/documents?page=1&size=50",
              "host": ["{{baseUrl}}"],
              "path": ["documents"],
              "query": [{ "key": "page", "value": "1" }, { "key": "size", "value": "50" }]
            }
          }
        },
        {
          "name": "List Documents BY DEAL",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/deal/1", "host": ["{{baseUrl}}"], "path": ["documents", "deal", "1"] }
          }
        },
        {
          "name": "Get Document by ID",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1", "host": ["{{baseUrl}}"], "path": ["documents", "1"] }
          }
        },
        {
          "name": "Open PDF inline (RBAC protected)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1/file", "host": ["{{baseUrl}}"], "path": ["documents", "1", "file"] }
          }
        },
        {
          "name": "Download PDF (RBAC protected)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1/download", "host": ["{{baseUrl}}"], "path": ["documents", "1", "download"] }
          }
        },
        {
          "name": "Delete Document",
          "request": {
            "method": "DELETE",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1", "host": ["{{baseUrl}}"], "path": ["documents", "1"] }
          }
        },
        {
          "name": "Submit Document (draft -> under_review) [Sales owner or elevated]",
          "request": {
            "method": "POST",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1/submit", "host": ["{{baseUrl}}"], "path": ["documents", "1", "submit"] }
          }
        },
        {
          "name": "Review Document (under_review -> approved/returned) [Ops/Mgmt/Admin]",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/documents/1/review", "host": ["{{baseUrl}}"], "path": ["documents", "1", "review"] },
            "body": { "mode": "raw", "raw": "{\n  \"action\": \"approve\"\n}" }
          }
        },
        {
          "name": "Sign Document (approved|returned -> signed) [Mgmt/Admin]",
          "request": {
            "method": "POST",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/documents/1/sign", "host": ["{{baseUrl}}"], "path": ["documents", "1", "sign"] }
          }
        }
      ]
    },
    {
      "name": "Tasks (staff/ops/mgmt/admin)",
      "item": [
        {
          "name": "Create Task",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/tasks", "host": ["{{baseUrl}}"], "path": ["tasks"] },
            "body": { "mode": "raw", "raw": "{\n  \"creator_id\": 1,\n  \"assignee_id\": 2,\n  \"entity_id\": 1,\n  \"entity_type\": \"deal\",\n  \"title\": \"Prepare contract\",\n  \"description\": \"Draft v1\",\n  \"status\": \"open\"\n}" }
          }
        },
        {
          "name": "List Tasks",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/tasks", "host": ["{{baseUrl}}"], "path": ["tasks"] }
          }
        }
      ]
    },
    {
      "name": "Messages (staff/ops/mgmt/admin)",
      "item": [
        {
          "name": "Send Message",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/messages", "host": ["{{baseUrl}}"], "path": ["messages"] },
            "body": { "mode": "raw", "raw": "{\n  \"receiver_id\": 2,\n  \"content\": \"Hello!\"\n}" }
          }
        },
        {
          "name": "Get Conversations",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/messages/conversations", "host": ["{{baseUrl}}"], "path": ["messages", "conversations"] }
          }
        },
        {
          "name": "Conversation History",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/messages/history/2", "host": ["{{baseUrl}}"], "path": ["messages", "history", "2"] }
          }
        }
      ]
    },
    {
      "name": "SMS (sales/ops/mgmt/admin)",
      "item": [
        {
          "name": "Send SMS for Document",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/sms/send", "host": ["{{baseUrl}}"], "path": ["sms", "send"] },
            "body": { "mode": "raw", "raw": "{\n  \"document_id\": 1,\n  \"phone\": \"+77000000000\"\n}" }
          }
        },
        {
          "name": "Resend SMS",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/sms/resend", "host": ["{{baseUrl}}"], "path": ["sms", "resend"] },
            "body": { "mode": "raw", "raw": "{\n  \"document_id\": 1\n}" }
          }
        },
        {
          "name": "Confirm SMS",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/sms/confirm", "host": ["{{baseUrl}}"], "path": ["sms", "confirm"] },
            "body": { "mode": "raw", "raw": "{\n  \"document_id\": 1,\n  \"sms_code\": \"1234\"\n}" }
          }
        },
        {
          "name": "Latest SMS by Document",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/sms/latest/1", "host": ["{{baseUrl}}"], "path": ["sms", "latest", "1"] }
          }
        },
        {
          "name": "Delete SMS by Document",
          "request": {
            "method": "DELETE",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/sms/1", "host": ["{{baseUrl}}"], "path": ["sms", "1"] }
          }
        }
      ]
    },
    {
      "name": "Reports (read-only)",
      "item": [
        {
          "name": "Summary",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": { "raw": "{{baseUrl}}/reports/summary", "host": ["{{baseUrl}}"], "path": ["reports", "summary"] }
          }
        },
        {
          "name": "Filter Leads",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/reports/leads/filter?status=confirmed&owner_id=1&sortBy=created_at&order=desc&limit=20&offset=0",
              "host": ["{{baseUrl}}"],
              "path": ["reports", "leads", "filter"],
              "query": [
                { "key": "status", "value": "confirmed" },
                { "key": "owner_id", "value": "1" },
                { "key": "sortBy", "value": "created_at" },
                { "key": "order", "value": "desc" },
                { "key": "limit", "value": "20" },
                { "key": "offset", "value": "0" }
              ]
            }
          }
        },
        {
          "name": "Filter Deals",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{accessToken}}" }],
            "url": {
              "raw": "{{baseUrl}}/reports/deals/filter?status=new&currency=USD&amountMin=0&amountMax=0&sortBy=created_at&order=desc&limit=20&offset=0",
              "host": ["{{baseUrl}}"],
              "path": ["reports", "deals", "filter"],
              "query": [
                { "key": "status", "value": "new" },
                { "key": "currency", "value": "USD" },
                { "key": "amountMin", "value": "0" },
                { "key": "amountMax", "value": "0" },
                { "key": "sortBy", "value": "created_at" },
                { "key": "order", "value": "desc" },
                { "key": "limit", "value": "20" },
                { "key": "offset", "value": "0" }
              ]
            }
          }
        }
      ]
    }
  ],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:4000" },
    { "key": "accessToken", "value": "" },
    { "key": "refreshToken", "value": "" }
  ]
}
